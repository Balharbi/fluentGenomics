<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fluent genomics with plyranges and tximeta • fluentGenomics</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/journal/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Fluent genomics with plyranges and tximeta">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fluentGenomics</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/fluentGenomics.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/sa-lee/fluentGenomics">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Fluent genomics with plyranges and tximeta</h1>
                        <h4 class="author">Stuart Lee, Michael Lawrence, Michael Love</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/sa-lee/fluentGenomics/blob/master/vignettes/fluentGenomics.Rmd"><code>vignettes/fluentGenomics.Rmd</code></a></small>
      <div class="hidden name"><code>fluentGenomics.Rmd</code></div>

    </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      We construct a simple workflow for fluent genomics data analysis using the R/Biocondcutor ecosystem. This involves three core steps: <strong>import</strong> the data into an appropriate abstraction, <strong>model</strong> the data with respect to the biological questions of interest, and <strong>transform</strong> the results with respect to their underlying genomic coordinates. Here we show how to implement these steps to integrate published RNA-seq and ATAC-seq experiments on macrophage cell lines. Using <em>tximeta</em>, we <strong>import</strong> RNA-seq transcript quantifications into an analysis-ready data structure, called the <em>SummarizedExperiment</em>, that contains the ranges of the reference transcripts and metadata on their provenance. Using <em>SummarizedExperiment</em>s to represent the ATAC-seq and RNA-seq data, we <strong>model</strong> differentially accessible (DA) chromatin peaks and differentially expressed (DE) genes with existing Bioconductor packages. Using <em>plyranges</em> we then <strong>transform</strong> the results to see if there is an enrichment of DE genes nearby DA peaks by finding overlaps and aggregating over log-fold change thresholds. The combination of these packages and their integration with the Bioconductor ecosystem provides a coherent framework for analysts to iteratively and reproducibly explore their biological data.
    </div>
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>In this workflow, we examine a subset of the RNA-seq and ATAC-seq data from <span class="citation">Alasoo et al. (2018)</span>, a study that involved treatment of macrophage cell lines from a number of human donors with interferon (IFN) gamma, <em>Salmonella</em> infection, or both treatments combined. <span class="citation">Alasoo et al. (2018)</span> examined gene expression and chromatin accessibility in a subset of 86 successfully differentiated induced pluripotent stem cells (iPSC) lines, and examined baseline quantitative trait loci (QTL) and response QTL for chromatin accessibility and gene expression. The authors found that many of the stimulus-specific expression QTL were already detectable as chromatin QTL in naive cells, and futher hypothesize about the nature and role of transcription factors implicated in the response to stimulus.</p>
<p>In this workflow, we will perform a much simpler analysis than the one found in <span class="citation">Alasoo et al. (2018)</span>, using their publicly available RNA-seq and ATAC-seq data (ignoring the genotypes). We will examine the effect of IFNg stimulation on gene expression and chromatin accessibility, and look to see if there is an enrichment of differentially accessible (DA) ATAC-seq peaks in the vicinity of differentially expressed (DE) genes. This is plausible, as the transcriptomic response to IFNg stimulation may be mediated through binding of regulatory proteins to accessible regions, and this binding may increase the accessibility of those regions such that it can be detected by ATAC-seq.</p>
<p>Throughout the workflow, we will use existing Bioconductor infrastructure to understand these datasets. In particular, we will emphasize the use of the Bioconductor packages <em>plyranges</em> and <em>tximeta</em>. The first package is be used to perform easily-readable transformations of data tied to genomic ranges, e.g. shifts, windows, overlaps, etc. The <em>plyranges</em> package is described by <span class="citation">Lee, Cook, and Lawrence (2019)</span>, and leverage underlying range operations described by <span class="citation">Lawrence (2013)</span>. The second package described by <span class="citation">Love et al. (2019)</span> is used to read RNA-seq quantification into R/Bioconductor, such that the transcript ranges and their provenance are automatically attached to an object containing the quantification data and the differential expression results.</p>
<div id="experimental-data" class="section level2">
<h2 class="hasAnchor">
<a href="#experimental-data" class="anchor"></a>Experimental Data</h2>
<p>The data used in this workflow is available from two packages: the <em>macrophage</em> Bioconductor ExperimentData package and from the workflow package <em>fluentGenomics</em>.</p>
<p>The <em>macrophage</em> package contains RNA-seq quantification from 24 RNA-seq samples, a subset of the RNA-seq samples generated and analyzed by <span class="citation">Alasoo et al. (2018)</span>. The paired-end reads were quantified using <em>Salmon</em> <span class="citation">(Patro et al. 2017)</span>, using the Gencode 29 human reference transcripts <span class="citation">(Frankish, GENCODE-consoritum, and Flicek 2018)</span>. For more details on quantification, and the exact code used, consult the vignette of the <a href="http://bioconductor.org/packages/macrophage">macrophage</a> package. The package also contains the <code>Snakemake</code> file that was used to distribute the <em>Salmon</em> quantification jobs on a cluster <span class="citation">(Köster and Rahmann 2012)</span>.</p>
<p>The <em>fluentGenomics</em> package contains functionality to download and generate a cached <em>SummarizedExperiment</em> object from the normalized ATAC-seq data provided by <span class="citation">Alasoo and Gaffney (2017)</span>. This object contains all 145 ATAC-seq samples across all experimental conditions as analyzed by <span class="citation">Alasoo et al. (2018)</span>. The data can be also be downloaded directly from the <a href="https://zenodo.org/record/1188300#.XIAhXlNKjOQ">Zenodo</a> deposition.</p>
<p>The following code loads the path to the cached data file, or if it is not present will create the cache and generate a <em>SummarizedExperiment</em> using the the <em>BiocFileCache</em> package <span class="citation">(Shepherd and Morgan 2019)</span>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(fluentGenomics)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">path_to_se &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cache-se.html">cache_atac_se</a></span>()</a></code></pre></div>
<p>We can then read the cached file and assign it to an object called <code>atac</code>. Note that this step is not strictly necessary to run the workflow.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">atac &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(path_to_se)</a></code></pre></div>
<p>A precise description of how we obtained this <em>SummarizedExperiment</em> object can be found in section @ref(atac).</p>
</div>
</div>
<div id="se" class="section level1">
<h1 class="hasAnchor">
<a href="#se" class="anchor"></a>Import Data as a <em>SummarizedExperiment</em>
</h1>
<div id="using-tximeta-to-import-rna-seq-quantification-data" class="section level2">
<h2 class="hasAnchor">
<a href="#using-tximeta-to-import-rna-seq-quantification-data" class="anchor"></a>Using <em>tximeta</em> to import RNA-seq quantification data</h2>
<p>First, we specify a directory <code>dir</code>, where the quantification files are stored. You could simply specify this directory with:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">dir &lt;-<span class="st"> "/path/to/quant/files"</span></a></code></pre></div>
<p>where the path is relative to your current R session. However, in this case we have distributed the files in the <em>macrophage</em> package. The relevant directory and associated files can be located using <code>system.file</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">dir &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="dt">package=</span><span class="st">"macrophage"</span>)</a></code></pre></div>
<p>Information about the experiment is contained in the <code>coldata.csv</code> file. We leverage the <em>dplyr</em> and <em>readr</em> packages (as part of the <em>tidyverse</em>) to read this file into R <span class="citation">(Wickham et al. 2019)</span>. We will see later that <em>plyranges</em> extends these packages to accommodate genomic ranges.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)</a></code></pre></div>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(readr)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">colfile &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(dir, <span class="st">"coldata.csv"</span>)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">coldata &lt;-<span class="st"> </span><span class="kw"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span>(colfile) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">    names,</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">    <span class="dt">id =</span> sample_id,</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">    <span class="dt">line =</span> line_id,</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">    <span class="dt">condition =</span> condition_name</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(</a>
<a class="sourceLine" id="cb9-11" data-line-number="11">    <span class="dt">files =</span> <span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(dir, <span class="st">"quants"</span>, names, <span class="st">"quant.sf.gz"</span>),</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">    <span class="dt">line =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(line),</a>
<a class="sourceLine" id="cb9-13" data-line-number="13">    <span class="dt">condition =</span> <span class="kw"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(condition), <span class="st">"naive"</span>)</a>
<a class="sourceLine" id="cb9-14" data-line-number="14">  )</a></code></pre></div>
<pre><code>## Parsed with column specification:
## cols(
##   names = col_character(),
##   sample_id = col_character(),
##   line_id = col_character(),
##   replicate = col_double(),
##   condition_name = col_character(),
##   macrophage_harvest = col_character(),
##   salmonella_date = col_character(),
##   ng_ul_mean = col_double(),
##   rna_extraction = col_character(),
##   rna_submit = col_character(),
##   library_pool = col_character(),
##   chemistry = col_character(),
##   rna_auto = col_double()
## )</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">coldata</a></code></pre></div>
<pre><code>## # A tibble: 24 x 5
##    names      id     line  condition  files                                     
##    &lt;chr&gt;      &lt;chr&gt;  &lt;fct&gt; &lt;fct&gt;      &lt;chr&gt;                                     
##  1 SAMEA1038… diku_A diku… naive      /home/travis/R/Library/macrophage/extdata…
##  2 SAMEA1038… diku_B diku… IFNg       /home/travis/R/Library/macrophage/extdata…
##  3 SAMEA1038… diku_C diku… SL1344     /home/travis/R/Library/macrophage/extdata…
##  4 SAMEA1038… diku_D diku… IFNg_SL13… /home/travis/R/Library/macrophage/extdata…
##  5 SAMEA1038… eiwy_A eiwy… naive      /home/travis/R/Library/macrophage/extdata…
##  6 SAMEA1038… eiwy_B eiwy… IFNg       /home/travis/R/Library/macrophage/extdata…
##  7 SAMEA1038… eiwy_C eiwy… SL1344     /home/travis/R/Library/macrophage/extdata…
##  8 SAMEA1038… eiwy_D eiwy… IFNg_SL13… /home/travis/R/Library/macrophage/extdata…
##  9 SAMEA1038… fikt_A fikt… naive      /home/travis/R/Library/macrophage/extdata…
## 10 SAMEA1038… fikt_B fikt… IFNg       /home/travis/R/Library/macrophage/extdata…
## # … with 14 more rows</code></pre>
<p>After we have read the <code>coldata.csv</code> file, we select relevant columns from this table, create a new column called <code>files</code>, and transform the existing <code>line</code> and <code>condition</code> columns into factors. In the case of <code>condition</code>, we specify the “naive” cell line as the reference level. The <code>files</code> column points to the quantifications for each observation - these files have been gzipped, but would typically not have the ‘gz’ ending if used from <code>salmon</code> directly. One other thing to note is the use of the pipe operator,<code><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">%&gt;%</a></code>, which can be read as “then”, i.e. first read the data, <em>then</em> select columns, <em>then</em> mutate them.</p>
<p>Now we have a data.frame summarizing the experimental design and the locations of the quantifications. The following lines of code do a lot of work for the analyst: importing the RNA-seq quantification (dropping <em>inferential replicates</em> in this case), locating the relevant reference transcriptome, attaching the transcript ranges to the data, and fetching genome information. Inferential replicates are especially useful for performing transcript-level analysis, but here we will use a point estimate for the per-gene counts and perform gene-level analysis.</p>
<p>The result is a <em>SummarizedExperiment</em> object.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(SummarizedExperiment))</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tximeta)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">se &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/tximeta/man/tximeta.html">tximeta</a></span>(coldata, <span class="dt">dropInfReps=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## importing quantifications</code></pre>
<pre><code>## reading in files with read_tsv</code></pre>
<pre><code>## 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 
## found matching linked transcriptome:
## [ GENCODE - Homo sapiens - release 29 ]
## building TxDb with 'GenomicFeatures' package
## Import genomic features from the file as a GRanges object ... OK
## Prepare the 'metadata' data frame ... OK
## Make the TxDb object ...</code></pre>
<pre><code>## Warning in .get_cds_IDX(mcols0$type, mcols0$phase): The "phase" metadata column contains non-NA values for features of type
##   stop_codon. This information was ignored.</code></pre>
<pre><code>## OK
## generating transcript ranges
## fetching genome info for GENCODE</code></pre>
<pre><code>## Warning in file(file, "rt"): cannot open URL 'ftp://
## ftp.ncbi.nlm.nih.gov/genomes/all/GCF/000/001/405/GCF_000001405.26_GRCh38/
## GCF_000001405.26_GRCh38_assembly_report.txt': FTP status was '421 Service not
## available, closing control connection'</code></pre>
<pre><code>## Error in file(file, "rt") : 
##   cannot open the connection to 'ftp://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/000/001/405/GCF_000001405.26_GRCh38/GCF_000001405.26_GRCh38_assembly_report.txt'</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">se</a></code></pre></div>
<pre><code>## class: RangedSummarizedExperiment 
## dim: 205870 24 
## metadata(6): tximetaInfo quantInfo ... txomeInfo txdbInfo
## assays(3): counts abundance length
## rownames(205870): ENST00000456328.2 ENST00000450305.2 ...
##   ENST00000387460.2 ENST00000387461.2
## rowData names(3): tx_id gene_id tx_name
## colnames(24): SAMEA103885102 SAMEA103885347 ... SAMEA103885308
##   SAMEA103884949
## colData names(4): names id line condition</code></pre>
<!-- should we describe the data structure in more detail, or use a figure -->
<p>On a machine with a working internet connection, the above command works without any extra steps, as the <code>tximeta</code> function obtains any necessary metadata via FTP, unless it is already cached locally. The <em>tximeta</em> package can also be used without an internet connection, in this case the linked transcriptome can be created directly from a <em>Salmon</em> index and gtf.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/tximeta/man/linkedTxome.html">makeLinkedTxome</a></span>(</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">  <span class="dt">indexDir=</span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(dir, <span class="st">"gencode.v29_salmon_0.12.0"</span>),</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">  <span class="dt">source=</span><span class="st">"Gencode"</span>,</a>
<a class="sourceLine" id="cb23-4" data-line-number="4">  <span class="dt">organism=</span><span class="st">"Homo sapiens"</span>,</a>
<a class="sourceLine" id="cb23-5" data-line-number="5">  <span class="dt">release=</span><span class="st">"29"</span>,</a>
<a class="sourceLine" id="cb23-6" data-line-number="6">  <span class="dt">genome=</span><span class="st">"GRCh38"</span>,</a>
<a class="sourceLine" id="cb23-7" data-line-number="7">  <span class="dt">fasta=</span><span class="st">"ftp://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_29/gencode.v29.transcripts.fa.gz"</span>,</a>
<a class="sourceLine" id="cb23-8" data-line-number="8">  <span class="dt">gtf=</span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(dir, <span class="st">"gencode.v29.annotation.gtf.gz"</span>), <span class="co"># local version</span></a>
<a class="sourceLine" id="cb23-9" data-line-number="9">  <span class="dt">write=</span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb23-10" data-line-number="10">)</a></code></pre></div>
<p>Because <em>tximeta</em> knows the correct reference transcriptome, we can ask <em>tximeta</em> to summarize the transcript-level data to the gene level using the methods of <span class="citation">Soneson, Love, and Robinson (2015)</span>.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">gse &lt;-<span class="st"> </span><span class="kw">summarizeToGene</span>(se)</a></code></pre></div>
<pre><code>## loading existing TxDb created: 2020-01-12 13:13:09</code></pre>
<pre><code>## Loading required package: GenomicFeatures</code></pre>
<pre><code>## Loading required package: AnnotationDbi</code></pre>
<pre><code>## 
## Attaching package: 'AnnotationDbi'</code></pre>
<pre><code>## The following object is masked from 'package:dplyr':
## 
##     select</code></pre>
<pre><code>## obtaining transcript-to-gene mapping from database</code></pre>
<pre><code>## generating gene ranges</code></pre>
<pre><code>## summarizing abundance</code></pre>
<pre><code>## summarizing counts</code></pre>
<pre><code>## summarizing length</code></pre>
</div>
<div id="importing-atac-seq-data-as-a-summarizedexperiment-object" class="section level2">
<h2 class="hasAnchor">
<a href="#importing-atac-seq-data-as-a-summarizedexperiment-object" class="anchor"></a>Importing ATAC-seq data as a <em>SummarizedExperiment</em> object</h2>
<p>The <em>SummarizedExperiment</em> object containing ATAC-seq peaks can be created from the following tab-delimited files from <span class="citation">Alasoo and Gaffney (2017)</span>:</p>
<ul>
<li>The sample metadata: <code>ATAC_sample_metadata.txt.gz</code> (&lt;1M)</li>
<li>The matrix of normalized read counts: <code>ATAC_cqn_matrix.txt.gz</code> (109M)</li>
<li>The annotated peaks: <code>ATAC_peak_metadata.txt.gz</code> (5.6M)</li>
</ul>
<p>To begin we read in the sample metadata, following similar steps to those we used to generate the <code>coldata</code> data.frame for the RNA-seq experiment:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1">atac_coldata &lt;-<span class="st"> </span><span class="kw"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_tsv</a></span>(<span class="st">"ATAC_sample_metadata.txt.gz"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-2" data-line-number="2"><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(</a>
<a class="sourceLine" id="cb35-3" data-line-number="3">    sample_id,</a>
<a class="sourceLine" id="cb35-4" data-line-number="4">    donor,</a>
<a class="sourceLine" id="cb35-5" data-line-number="5">    <span class="dt">condition =</span> condition_name</a>
<a class="sourceLine" id="cb35-6" data-line-number="6">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">condition =</span> <span class="kw"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(condition), <span class="st">"naive"</span>))</a></code></pre></div>
<p>The ATAC-seq counts have already been normalized with <em>cqn</em> <span class="citation">(Hansen, Irizarry, and Wu 2012)</span> and log2 transformed. Loading the <em>cqn</em>-normalized matrix of log2 transformed read counts takes ~30 seconds and loads an object of ~370 Mb. We set the column names so that the first column contains the rownames of the matrix, and the remaining columns are the sample identities from the <code>atac_coldata</code> object.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1">atac_mat &lt;-<span class="st"> </span><span class="kw"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_tsv</a></span>(<span class="st">"ATAC_cqn_matrix.txt.gz"</span>,</a>
<a class="sourceLine" id="cb36-2" data-line-number="2">                     <span class="dt">skip =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb36-3" data-line-number="3">                     <span class="dt">col_names =</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"rownames"</span>, atac_coldata[[<span class="st">"sample_id"</span>]]))</a>
<a class="sourceLine" id="cb36-4" data-line-number="4">rownames &lt;-<span class="st"> </span>atac_mat[[<span class="st">"rownames"</span>]]</a>
<a class="sourceLine" id="cb36-5" data-line-number="5">atac_mat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(atac_mat[,<span class="op">-</span><span class="dv">1</span>])</a>
<a class="sourceLine" id="cb36-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(atac_mat) &lt;-<span class="st"> </span>rownames</a></code></pre></div>
<p>We read in the peak metadata (locations in the genome), and convert it to a <em>GRanges</em> object. The <code><a href="https://rdrr.io/pkg/plyranges/man/ranges-construct.html">as_granges()</a></code> function automatically converts the data.frame into a <em>GRanges</em> object, from that result, we extract the peak_id column and set the genome information to the build “GRCh38”. We know this from the <a href="https://zenodo.org/record/1188300#.XJOFSlNKiL5">Zenodo entry</a>.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(plyranges)</a>
<a class="sourceLine" id="cb37-2" data-line-number="2">peaks_df &lt;-<span class="st"> </span><span class="kw"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_tsv</a></span>(<span class="st">"ATAC_peak_metadata.txt.gz"</span>,</a>
<a class="sourceLine" id="cb37-3" data-line-number="3">  <span class="dt">col_types =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cidciicdc"</span>)</a>
<a class="sourceLine" id="cb37-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb37-5" data-line-number="5"></a>
<a class="sourceLine" id="cb37-6" data-line-number="6">peaks_gr &lt;-<span class="st"> </span>peaks_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/ranges-construct.html">as_granges</a></span>(<span class="dt">seqnames =</span> chr) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">select</a></span>(<span class="dt">peak_id=</span>gene_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-9" data-line-number="9"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/ranges-info.html">set_genome_info</a></span>(<span class="dt">genome =</span> <span class="st">"GRCh38"</span>)</a></code></pre></div>
<p>Finally, we construct a <em>SummarizedExperiment</em> object. We place the matrix into the assays slot as a named list, the annotated peaks into the row-wise ranges slot, and the sample metadata into the column-wise data slot:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1">atac &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/RangedSummarizedExperiment-class.html">SummarizedExperiment</a></span>(<span class="dt">assays =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">cqndata=</span>atac_mat),</a>
<a class="sourceLine" id="cb38-2" data-line-number="2">                             <span class="dt">rowRanges=</span>peaks_gr,</a>
<a class="sourceLine" id="cb38-3" data-line-number="3">                             <span class="dt">colData=</span>atac_coldata)</a></code></pre></div>
</div>
</div>
<div id="model" class="section level1">
<h1 class="hasAnchor">
<a href="#model" class="anchor"></a>Model</h1>
<div id="rna-seq-differential-gene-expression-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#rna-seq-differential-gene-expression-analysis" class="anchor"></a>RNA-seq differential gene expression analysis</h2>
<p>We can easily run a differential expression analysis with <em>DESeq2</em> using the following code chunks <span class="citation">(Love, Huber, and Anders 2014)</span>. The design formula indicates that we want to control for the donor baselines (<code>line</code>) and test for differences in gene expression on the condition. For a more comprehensive discussion of DE workflows in Bioconductor see <span class="citation">Love et al. (2016)</span> and <span class="citation">Law et al. (2018)</span>.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(DESeq2)</a>
<a class="sourceLine" id="cb39-2" data-line-number="2">dds &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/DESeq2/man/DESeqDataSet.html">DESeqDataSet</a></span>(gse, <span class="op">~</span>line <span class="op">+</span><span class="st"> </span>condition)</a></code></pre></div>
<pre><code>## using counts and average transcript lengths from tximeta</code></pre>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1"><span class="co"># filter out lowly expressed genes</span></a>
<a class="sourceLine" id="cb41-2" data-line-number="2"><span class="co"># at least 10 counts in at least 6 samples</span></a>
<a class="sourceLine" id="cb41-3" data-line-number="3">keep &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/DESeq2/man/counts.html">counts</a></span>(dds) <span class="op">&gt;=</span><span class="st"> </span><span class="dv">10</span>) <span class="op">&gt;=</span><span class="st"> </span><span class="dv">6</span></a>
<a class="sourceLine" id="cb41-4" data-line-number="4">dds &lt;-<span class="st"> </span>dds[keep,]</a></code></pre></div>
<p>The model is fit with the following line of code:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1">dds &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/DESeq2/man/DESeq.html">DESeq</a></span>(dds)</a></code></pre></div>
<pre><code>## estimating size factors</code></pre>
<pre><code>## using 'avgTxLength' from assays(dds), correcting for library size</code></pre>
<pre><code>## estimating dispersions</code></pre>
<pre><code>## gene-wise dispersion estimates</code></pre>
<pre><code>## mean-dispersion relationship</code></pre>
<pre><code>## final dispersion estimates</code></pre>
<pre><code>## fitting model and testing</code></pre>
<p>Below we set the contrasts on the condition variable, indicating we are estimating log2 fold changes of IFNg stimulated cell lines against naive cell lines. We are interested in log fold changes greater than 1 at a false discovery rate at of 1%.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" data-line-number="1">res &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/DESeq2/man/results.html">results</a></span>(dds,</a>
<a class="sourceLine" id="cb50-2" data-line-number="2">               <span class="dt">contrast=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"condition"</span>,<span class="st">"IFNg"</span>,<span class="st">"naive"</span>),</a>
<a class="sourceLine" id="cb50-3" data-line-number="3">               <span class="dt">lfcThreshold=</span><span class="dv">1</span>, <span class="dt">alpha=</span><span class="fl">0.01</span>)</a></code></pre></div>
<p>To see the results of the expression analysis, we can generate a summary table and an MA plot:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/DESeq2/man/summary.html">summary</a></span>(res)</a></code></pre></div>
<pre><code>## 
## out of 17806 with nonzero total read count
## adjusted p-value &lt; 0.01
## LFC &gt; 1.00 (up)    : 502, 2.8%
## LFC &lt; -1.00 (down) : 247, 1.4%
## outliers [1]       : 0, 0%
## low counts [2]     : 0, 0%
## (mean count &lt; 3)
## [1] see 'cooksCutoff' argument of ?results
## [2] see 'independentFiltering' argument of ?results</code></pre>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" data-line-number="1">DESeq2<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/DESeq2/man/plotMA.html">plotMA</a></span>(res, <span class="dt">ylim=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="dv">10</span>,<span class="dv">10</span>))</a></code></pre></div>
<p><img src="fluentGenomics_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>We now output the results as a <em>GRanges</em> object, due to the conventions of <em>plyranges</em> we construct a new column called <code>gene_id</code> from the row names of the results. Each row now contains the genomic region (<code>seqnames</code>, <code>start</code>, <code>end</code>, <code>strand</code>) along with corresponding metadata columns (the <code>gene_id</code> and the results of the test). Note that <em>tximeta</em> has correctly identified the reference genome as “hg38”, and this has also been added to the <em>GRanges</em> along the results columns. This kind of book-keeping is vital once overlap operations are performed to ensure that <em>plyranges</em> is not comparing across incompatible genomes.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(plyranges))</a>
<a class="sourceLine" id="cb54-2" data-line-number="2">de_genes &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/DESeq2/man/results.html">results</a></span>(dds,</a>
<a class="sourceLine" id="cb54-3" data-line-number="3">                    <span class="dt">contrast=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"condition"</span>,<span class="st">"IFNg"</span>,<span class="st">"naive"</span>),</a>
<a class="sourceLine" id="cb54-4" data-line-number="4">                    <span class="dt">lfcThreshold=</span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb54-5" data-line-number="5">                    <span class="dt">format=</span><span class="st">"GRanges"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/ranges-names.html">names_to_column</a></span>(<span class="st">"gene_id"</span>)</a>
<a class="sourceLine" id="cb54-7" data-line-number="7">de_genes</a></code></pre></div>
<pre><code>## GRanges object with 17806 ranges and 7 metadata columns:
##           seqnames              ranges strand |            gene_id   baseMean
##              &lt;Rle&gt;           &lt;IRanges&gt;  &lt;Rle&gt; |        &lt;character&gt;  &lt;numeric&gt;
##       [1]     chrX 100627109-100639991      - | ENSG00000000003.14    171.571
##       [2]    chr20   50934867-50958555      - | ENSG00000000419.12    967.751
##       [3]     chr1 169849631-169894267      - | ENSG00000000457.13    682.433
##       [4]     chr1 169662007-169854080      + | ENSG00000000460.16    262.963
##       [5]     chr1   27612064-27635277      - | ENSG00000000938.12   2660.102
##       ...      ...                 ...    ... .                ...        ...
##   [17802]    chr10   84167228-84172093      - |  ENSG00000285972.1   10.04746
##   [17803]     chr6   63572012-63583587      + |  ENSG00000285976.1 4586.34617
##   [17804]    chr16   57177349-57181390      + |  ENSG00000285979.1   14.29653
##   [17805]     chr8 103398658-103501895      - |  ENSG00000285982.1   27.76296
##   [17806]    chr10   12563151-12567351      + |  ENSG00000285994.1    6.60409
##           log2FoldChange     lfcSE      stat    pvalue      padj
##                &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;
##       [1]     -0.2822450 0.3005710   0.00000 1.0000000  1.000000
##       [2]      0.0391223 0.0859708   0.00000 1.0000000  1.000000
##       [3]      1.2846179 0.1969067   1.44545 0.1483329  1.000000
##       [4]     -1.4718762 0.2186916  -2.15772 0.0309493  0.409728
##       [5]      0.6754781 0.2360530   0.00000 1.0000000  1.000000
##       ...            ...       ...       ...       ...       ...
##   [17802]      0.5484518  0.444319         0         1         1
##   [17803]     -0.0339296  0.188005         0         1         1
##   [17804]      0.3123477  0.522700         0         1         1
##   [17805]      0.9945187  1.582373         0         1         1
##   [17806]      0.2539975  0.595751         0         1         1
##   -------
##   seqinfo: 25 sequences (1 circular) from an unspecified genome; no seqlengths</code></pre>
<p>From this, we can restrict the results to those that meet our FDR threshold and select (and rename) the metadata columns we’re interested in:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" data-line-number="1">de_genes &lt;-<span class="st"> </span>de_genes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb56-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">filter</a></span>(padj <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.01</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb56-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">select</a></span>(gene_id, <span class="dt">de_log2FC =</span> log2FoldChange, <span class="dt">de_padj =</span> padj)</a></code></pre></div>
<p>We now wish to extract genes for which we could <em>not</em> reject the null hypothesis (we select based on an un-adjusted p-value larger than 0.1 for example). We must re-run <code>results</code> because we don’t want to use an <code>lfcThreshold</code> this time. For brevity we will label these genes as <code>other_genes</code>, and later on we will use these for comparison with our <code>de_genes</code> set.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" data-line-number="1">other_genes &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/DESeq2/man/results.html">results</a></span>(dds,</a>
<a class="sourceLine" id="cb57-2" data-line-number="2">                       <span class="dt">contrast=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"condition"</span>,<span class="st">"IFNg"</span>,<span class="st">"naive"</span>),</a>
<a class="sourceLine" id="cb57-3" data-line-number="3">                       <span class="dt">format=</span><span class="st">"GRanges"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">filter</a></span>(pvalue <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/ranges-names.html">names_to_column</a></span>(<span class="st">"gene_id"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-6" data-line-number="6"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(gene_id,</a>
<a class="sourceLine" id="cb57-7" data-line-number="7">                <span class="dt">de_log2FC =</span> log2FoldChange,</a>
<a class="sourceLine" id="cb57-8" data-line-number="8">                <span class="dt">de_padj =</span> padj)</a></code></pre></div>
</div>
<div id="atac-seq-peak-differential-abundance-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#atac-seq-peak-differential-abundance-analysis" class="anchor"></a>ATAC-seq peak differential abundance analysis</h2>
<p>The following section describes the process we have used for generating a <em>GRanges</em> object of differential peaks from the ATAC-seq data in <span class="citation">Alasoo et al. (2018)</span>.</p>
<p>The code chunks for the remainder of this section are not run.</p>
<!-- We can check the standard deviation over mean plot, to assess for any -->
<!-- systematic trends: -->
<!-- ```{r, eval = retrieve_cache} -->
<!-- library(ggplot2) -->
<!-- mv <-
data.frame(rmu = rowMeans(assay(atac)), -->
<!-- rvar = rowVars(assay(atac)))
-->
<!-- ggplot(data =mv , aes(x = rmu, y = sqrt(rvar))) + -->
<!-- geom_hex()
-->
<!-- ``` -->
<p>For assessing differential accessibility, we run <em>limma</em> <span class="citation">(Smyth 2004)</span>, and generate the a summary of log fold changes and adjusted p-values for the peaks:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(limma)</a>
<a class="sourceLine" id="cb58-2" data-line-number="2">design &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span>(<span class="op">~</span>donor <span class="op">+</span><span class="st"> </span>condition, <span class="kw"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">colData</a></span>(atac))</a>
<a class="sourceLine" id="cb58-3" data-line-number="3">fit &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/limma/man/lmFit.html">lmFit</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">assay</a></span>(atac), design)</a>
<a class="sourceLine" id="cb58-4" data-line-number="4">fit &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/limma/man/ebayes.html">eBayes</a></span>(fit)</a>
<a class="sourceLine" id="cb58-5" data-line-number="5">idx &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(fit<span class="op">$</span>coefficients) <span class="op">==</span><span class="st"> "conditionIFNg"</span>)</a>
<a class="sourceLine" id="cb58-6" data-line-number="6">tt &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/limma/man/toptable.html">topTable</a></span>(fit, <span class="dt">coef=</span>idx, <span class="dt">sort.by=</span><span class="st">"none"</span>, <span class="dt">n=</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(atac))</a></code></pre></div>
<p>We now take the <code>rowRanges</code> of the <em>SummarizedExperiment</em> and attach the LFC and adjusted p-value from <em>limma</em>, so that we can consider the overlap with differential expression. Note that we set the genome build to “hg38” and restyle the chromosome information to use the “UCSC” style.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" data-line-number="1">atac_peaks &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/RangedSummarizedExperiment-class.html">rowRanges</a></span>(atac) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/ranges-names.html">remove_names</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">mutate</a></span>(</a>
<a class="sourceLine" id="cb59-4" data-line-number="4">    <span class="dt">da_log2FC =</span> tt<span class="op">$</span>logFC,</a>
<a class="sourceLine" id="cb59-5" data-line-number="5">    <span class="dt">da_padj =</span> tt<span class="op">$</span>adj.P.Val</a>
<a class="sourceLine" id="cb59-6" data-line-number="6">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/ranges-info.html">set_genome_info</a></span>(<span class="dt">genome =</span> <span class="st">"hg38"</span>)</a>
<a class="sourceLine" id="cb59-8" data-line-number="8"></a>
<a class="sourceLine" id="cb59-9" data-line-number="9"><span class="kw">seqlevelsStyle</span>(atac_peaks) &lt;-<span class="st"> "UCSC"</span></a></code></pre></div>
<p>The final <em>GRanges</em> object containing the DA peaks is included in the workflow package and can be loaded as follows:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(fluentGenomics)</a>
<a class="sourceLine" id="cb60-2" data-line-number="2">peaks</a></code></pre></div>
<pre><code>## GRanges object with 296220 ranges and 3 metadata columns:
##            seqnames              ranges strand |          peak_id da_log2FC
##               &lt;Rle&gt;           &lt;IRanges&gt;  &lt;Rle&gt; |      &lt;character&gt; &lt;numeric&gt;
##        [1]     chr1          9979-10668      * |      ATAC_peak_1  0.266185
##        [2]     chr1         10939-11473      * |      ATAC_peak_2  0.322177
##        [3]     chr1         15505-15729      * |      ATAC_peak_3 -0.574160
##        [4]     chr1         21148-21481      * |      ATAC_peak_4 -1.147066
##        [5]     chr1         21864-22067      * |      ATAC_peak_5 -0.896143
##        ...      ...                 ...    ... .              ...       ...
##   [296216]     chrX 155896572-155896835      * | ATAC_peak_296216 -0.834629
##   [296217]     chrX 155958507-155958646      * | ATAC_peak_296217 -0.147537
##   [296218]     chrX 156016760-156016975      * | ATAC_peak_296218 -0.609732
##   [296219]     chrX 156028551-156029422      * | ATAC_peak_296219 -0.347678
##   [296220]     chrX 156030135-156030785      * | ATAC_peak_296220  0.492442
##                da_padj
##              &lt;numeric&gt;
##        [1] 9.10673e-05
##        [2] 2.03435e-05
##        [3] 3.41708e-08
##        [4] 8.22299e-26
##        [5] 4.79453e-11
##        ...         ...
##   [296216] 1.33546e-11
##   [296217] 3.13015e-01
##   [296218] 3.62339e-09
##   [296219] 6.94823e-06
##   [296220] 7.07664e-13
##   -------
##   seqinfo: 23 sequences from hg38 genome; no seqlengths</code></pre>
</div>
</div>
<div id="transform" class="section level1">
<h1 class="hasAnchor">
<a href="#transform" class="anchor"></a>Transform</h1>
<div id="finding-overlaps-with-plyranges" class="section level2">
<h2 class="hasAnchor">
<a href="#finding-overlaps-with-plyranges" class="anchor"></a>Finding overlaps with <em>plyranges</em>
</h2>
<p>We have already used <em>plyranges</em> a number of times above, to <code>filter</code>, <code>mutate</code> and <code>select</code> on <em>GRanges</em> objects, as well as ensuring the correct genome annotation and style has been used.</p>
<p>For the overlap analysis, we filter the annotated peaks to have a nominal FDR bound of 1%.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" data-line-number="1">da_peaks &lt;-<span class="st"> </span>peaks <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb62-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">filter</a></span>(da_padj <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.01</span>)</a></code></pre></div>
<p>We now have <em>GRanges</em> objects that contain DE genes, genes without strong signal of DE, and DA peaks. We are ready to perform our original aim and answer the question: is there an enrichment of DA ATAC-seq peaks in the vicinity of DE genes?</p>
</div>
<div id="down-sampling-non-differentially-expressed-genes" class="section level2">
<h2 class="hasAnchor">
<a href="#down-sampling-non-differentially-expressed-genes" class="anchor"></a>Down sampling non-differentially expressed genes</h2>
<p>As <em>plyranges</em> is built on top of <em>dplyr</em> it implements methods for many of it’s verbs for <em>GRanges</em> objects. Here we can use, <code>slice</code> to randomly sample the rows of the <code>other_genes</code>. The <code>sample.int</code> function will generate random samples of size equal to the number of DE-genes from the number of rows in <code>other_genes</code>:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" data-line-number="1">size &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(de_genes)</a>
<a class="sourceLine" id="cb63-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">slice</a></span>(other_genes, <span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/n.html">n</a></span>(), size))</a></code></pre></div>
<pre><code>## GRanges object with 749 ranges and 3 metadata columns:
##         seqnames              ranges strand |            gene_id   de_log2FC
##            &lt;Rle&gt;           &lt;IRanges&gt;  &lt;Rle&gt; |        &lt;character&gt;   &lt;numeric&gt;
##     [1]     chr6 158232236-158511828      + | ENSG00000130338.12  0.00366373
##     [2]     chr3   32105689-32168713      + | ENSG00000152642.10 -0.31904728
##     [3]     chr2   64453969-64461381      + | ENSG00000119862.12  0.36318376
##     [4]    chr14   76151916-76254342      + | ENSG00000089916.17 -0.18341183
##     [5]    chr17     7012635-7017520      + | ENSG00000161939.19  0.49907766
##     ...      ...                 ...    ... .                ...         ...
##   [745]     chrX 154379197-154381523      + | ENSG00000102119.10 -0.16257338
##   [746]     chr1     6624866-6635586      + | ENSG00000041988.15  0.15754432
##   [747]    chr19     4444999-4457822      - | ENSG00000167671.11  0.00173181
##   [748]    chr16   57447425-57461275      + | ENSG00000088682.13  0.01315355
##   [749]    chr13   48389567-48444704      - | ENSG00000139679.15  0.21176792
##           de_padj
##         &lt;numeric&gt;
##     [1]  0.991572
##     [2]  0.412507
##     [3]  0.704881
##     [4]  0.297062
##     [5]  0.439643
##     ...       ...
##   [745]  0.281674
##   [746]  0.548696
##   [747]  0.993378
##   [748]  0.958482
##   [749]  0.550456
##   -------
##   seqinfo: 25 sequences (1 circular) from an unspecified genome; no seqlengths</code></pre>
<p>We can repeat this many times to create many samples via replicate:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" data-line-number="1"><span class="co"># set a seed for the results</span></a>
<a class="sourceLine" id="cb65-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">2019-08-02</span>)</a>
<a class="sourceLine" id="cb65-3" data-line-number="3">boot_genes &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span>(<span class="dv">10</span>,</a>
<a class="sourceLine" id="cb65-4" data-line-number="4">                        <span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">slice</a></span>(other_genes, <span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/n.html">n</a></span>(), size)),</a>
<a class="sourceLine" id="cb65-5" data-line-number="5">                        <span class="dt">simplify =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p>This creates a list of <em>GRanges</em> objects as a list, we can bind these together using the <code>bind_ranges</code> function. This function creates a new column called “resample” on the result that identifies each of the input <em>GRanges</em> objects:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" data-line-number="1">boot_genes &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/ranges-bind.html">bind_ranges</a></span>(boot_genes, <span class="dt">.id =</span> <span class="st">"resample"</span>)</a></code></pre></div>
<p>Similarly, we can then combine the <code>boot_genes</code> <em>GRanges</em>, with the DE <em>GRanges</em> object. As the resample column was not present on the DE <em>GRanges</em> object, this is given a missing value which we recode to a 0 using <code><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">mutate()</a></code></p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" data-line-number="1">all_genes &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/ranges-bind.html">bind_ranges</a></span>(</a>
<a class="sourceLine" id="cb67-2" data-line-number="2">  <span class="dt">de=</span>de_genes,</a>
<a class="sourceLine" id="cb67-3" data-line-number="3">  <span class="dt">not_de =</span> boot_genes,</a>
<a class="sourceLine" id="cb67-4" data-line-number="4">  <span class="dt">.id=</span><span class="st">"origin"</span></a>
<a class="sourceLine" id="cb67-5" data-line-number="5">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb67-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">mutate</a></span>(</a>
<a class="sourceLine" id="cb67-7" data-line-number="7">    <span class="dt">origin =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(origin, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"not_de"</span>, <span class="st">"de"</span>)),</a>
<a class="sourceLine" id="cb67-8" data-line-number="8">    <span class="dt">resample =</span> <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(resample), 0L, <span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(resample))</a>
<a class="sourceLine" id="cb67-9" data-line-number="9">  )</a>
<a class="sourceLine" id="cb67-10" data-line-number="10">all_genes</a></code></pre></div>
<pre><code>## GRanges object with 8239 ranges and 5 metadata columns:
##          seqnames              ranges strand |            gene_id  de_log2FC
##             &lt;Rle&gt;           &lt;IRanges&gt;  &lt;Rle&gt; |        &lt;character&gt;  &lt;numeric&gt;
##      [1]     chr1 196651878-196747504      + | ENSG00000000971.15    4.98711
##      [2]     chr6   46129993-46146699      + |  ENSG00000001561.6    1.92722
##      [3]     chr4   17577192-17607972      + | ENSG00000002549.12    2.93373
##      [4]     chr7 150800403-150805120      + |  ENSG00000002933.8    3.16722
##      [5]     chr4   15778275-15853230      + | ENSG00000004468.12    5.40894
##      ...      ...                 ...    ... .                ...        ...
##   [8235]     chr3   72749277-72861914      - | ENSG00000144736.13 -0.3240580
##   [8236]    chr17   29566052-29573157      + | ENSG00000167543.15  0.0582049
##   [8237]     chr7 129225023-129430211      + | ENSG00000158467.16  0.2845564
##   [8238]     chr2   24029340-24049575      - | ENSG00000163026.11 -0.1305761
##   [8239]    chr16     1826941-1840207      + | ENSG00000180185.11  0.1739038
##              de_padj  resample   origin
##            &lt;numeric&gt; &lt;integer&gt; &lt;factor&gt;
##      [1] 1.37057e-13         0       de
##      [2] 3.17478e-05         0       de
##      [3] 2.01310e-11         0       de
##      [4] 1.07360e-08         0       de
##      [5] 4.82905e-18         0       de
##      ...         ...       ...      ...
##   [8235]    0.531385        10   not_de
##   [8236]    0.681057        10   not_de
##   [8237]    0.378275        10   not_de
##   [8238]    0.601621        10   not_de
##   [8239]    0.568644        10   not_de
##   -------
##   seqinfo: 25 sequences (1 circular) from an unspecified genome; no seqlengths</code></pre>
</div>
<div id="expanding-genomic-coordinates-around-the-transcription-start-site" class="section level2">
<h2 class="hasAnchor">
<a href="#expanding-genomic-coordinates-around-the-transcription-start-site" class="anchor"></a>Expanding genomic coordinates around the transcription start site</h2>
<p>Now we would like to modify our gene ranges so their width is 10 kilobases on either side of their transcription start site (TSS). There are many ways one could do this but we prefer an approach via the anchoring methods in <em>plyranges</em>. Because there is a mutual dependence between the start, end, width and strand of a <em>GRanges</em> object, we define anchors to fix one of start and end, while modifying the width. As an example to extract just the TSS, we can anchor by the 5’ end of the range and modify the width of the range to equal 1.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" data-line-number="1">all_genes &lt;-<span class="st"> </span>all_genes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/ranges-anchor.html">anchor_5p</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">mutate</a></span>(<span class="dt">width =</span> <span class="dv">1</span>)</a></code></pre></div>
<p>Anchoring by the 5’ end of a range will fix the end of negatively stranded ranges, and fix the start of positively stranded ranges.</p>
<p>We can then repeat the same pattern but this time using <code><a href="https://rdrr.io/pkg/plyranges/man/ranges-anchor.html">anchor_center()</a></code> to tell <em>plyranges</em> that we are making the TSS the midpoint of a range that has total width of 20kb, or 10kb both upstream and downstream of the TSS.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" data-line-number="1">all_genes &lt;-all_genes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb70-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/ranges-anchor.html">anchor_center</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb70-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">mutate</a></span>(<span class="dt">width=</span><span class="dv">2</span><span class="op">*</span><span class="fl">1e4</span>)</a></code></pre></div>
</div>
<div id="use-overlap-joins-to-find-relative-enrichment" class="section level2">
<h2 class="hasAnchor">
<a href="#use-overlap-joins-to-find-relative-enrichment" class="anchor"></a>Use overlap joins to find relative enrichment</h2>
<p>We are now ready to compute overlaps between RNA-seq genes (our DE set and bootstrap samples) and the ATAC-seq peaks. In <em>plyranges</em>, overlaps are defined as joins between two <em>GRanges</em> objects: a <em>left</em> and a <em>right</em> <em>GRanges</em> object. In an overlap join, a match is any range on the <em>left</em> <em>GRanges</em> that is overlapped by the <em>right</em> <em>GRanges</em>. One powerful aspect of the overlap joins is that the result maintains all (metadata) columns from each of the <em>left</em> and <em>right</em> ranges which makes downstream summaries easy to compute.</p>
<p>To combine the DE genes with the DA peaks, we perform a left overlap join. This returns to us the <code>all_genes</code> ranges (potentially with duplication), but with the metadata columns from those overlapping DA peaks. For any gene that has no overlaps, the DA peak columns will have <code>NA</code>’s.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" data-line-number="1">genes_olap_peaks &lt;-<span class="st"> </span>all_genes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb71-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/overlap-joins.html">join_overlap_left</a></span>(da_peaks)</a>
<a class="sourceLine" id="cb71-3" data-line-number="3">genes_olap_peaks</a></code></pre></div>
<pre><code>## GRanges object with 27591 ranges and 8 metadata columns:
##           seqnames              ranges strand |            gene_id  de_log2FC
##              &lt;Rle&gt;           &lt;IRanges&gt;  &lt;Rle&gt; |        &lt;character&gt;  &lt;numeric&gt;
##       [1]     chr1 196641878-196661877      + | ENSG00000000971.15    4.98711
##       [2]     chr6   46119993-46139992      + |  ENSG00000001561.6    1.92722
##       [3]     chr4   17567192-17587191      + | ENSG00000002549.12    2.93373
##       [4]     chr4   17567192-17587191      + | ENSG00000002549.12    2.93373
##       [5]     chr4   17567192-17587191      + | ENSG00000002549.12    2.93373
##       ...      ...                 ...    ... .                ...        ...
##   [27587]    chr17   29556052-29576051      + | ENSG00000167543.15  0.0582049
##   [27588]     chr7 129215023-129235022      + | ENSG00000158467.16  0.2845564
##   [27589]     chr2   24039575-24059574      - | ENSG00000163026.11 -0.1305761
##   [27590]    chr16     1816941-1836940      + | ENSG00000180185.11  0.1739038
##   [27591]    chr16     1816941-1836940      + | ENSG00000180185.11  0.1739038
##               de_padj  resample   origin          peak_id da_log2FC     da_padj
##             &lt;numeric&gt; &lt;integer&gt; &lt;factor&gt;      &lt;character&gt; &lt;numeric&gt;   &lt;numeric&gt;
##       [1] 1.37057e-13         0       de  ATAC_peak_21236 -0.546582 1.15274e-04
##       [2] 3.17478e-05         0       de ATAC_peak_231183  1.453297 9.73225e-17
##       [3] 2.01310e-11         0       de ATAC_peak_193578  0.222371 3.00939e-11
##       [4] 2.01310e-11         0       de ATAC_peak_193579 -0.281615 7.99889e-05
##       [5] 2.01310e-11         0       de ATAC_peak_193580  0.673705 7.60043e-15
##       ...         ...       ...      ...              ...       ...         ...
##   [27587]    0.681057        10   not_de ATAC_peak_109304  0.211751 1.11290e-03
##   [27588]    0.378275        10   not_de ATAC_peak_255700  0.177364 5.25385e-09
##   [27589]    0.601621        10   not_de ATAC_peak_133247 -0.266266 1.01550e-07
##   [27590]    0.568644        10   not_de  ATAC_peak_97065 -0.405271 1.28055e-05
##   [27591]    0.568644        10   not_de  ATAC_peak_97067  0.289105 5.87370e-07
##   -------
##   seqinfo: 25 sequences (1 circular) from an unspecified genome; no seqlengths</code></pre>
<p>Now we can ask, how many DA peaks are near DE genes relative to “other” non-DE genes? A gene may appear more than once in <code>genes_olap_peaks</code>, because multiple peaks may overlap a single gene, or because we have re-sampled the same gene more than once, or a combination of these two cases.</p>
<p>For each gene (that is the combination of chromosome, the start, end and strand), and the “origin” (DE vs not-DE) we can compute the distinct number of peaks for each gene and the maximum peak based on log FC. This is achieved via <code>reduce_ranges_directed</code>, which allows an aggregation to result in a GRanges object via merging neighboring genomic regions. The use of the directed suffix indicates we’re maintaining strand information. In this case, we are simply merging ranges via the groups we mentioned above. We also have to account for the number of resamples we have performed when counting if there are any peaks, to ensure we do not double count the same peak:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" data-line-number="1">gene_peak_max_lfc &lt;-<span class="st"> </span>genes_olap_peaks <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">group_by</a></span>(gene_id, origin)  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/ranges-reduce.html">reduce_ranges_directed</a></span>(</a>
<a class="sourceLine" id="cb73-4" data-line-number="4">    <span class="dt">peak_count =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(da_padj)) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/n_distinct.html">n_distinct</a></span>(resample),</a>
<a class="sourceLine" id="cb73-5" data-line-number="5">    <span class="dt">peak_max_lfc =</span> <span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(da_log2FC))</a>
<a class="sourceLine" id="cb73-6" data-line-number="6">  )</a></code></pre></div>
<p>We can then filter genes if they have any peaks and compare the peak fold changes between non-DE and DE genes using a boxplot:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb74-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb74-2" data-line-number="2">gene_peak_max_lfc <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">filter</a></span>(peak_count <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(origin, peak_max_lfc)) <span class="op">+</span></a>
<a class="sourceLine" id="cb74-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span>()</a></code></pre></div>
<p><img src="fluentGenomics_files/figure-html/unnamed-chunk-30-1.png" width="700"></p>
<p>In general, the DE genes have larger DA fold changes relative to the non-DE genes.</p>
<p>Next we examine how changes in DA LFC alter enrichment for DE genes. First, we want to know how the number of peaks within DE genes and non-DE genes change as we change threshold values on the peak LFC. As an example, we could compute this by arbitrarily chosen LFC thresholds as follows:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" data-line-number="1">origin_peak_lfc &lt;-<span class="st"> </span>genes_olap_peaks <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb75-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">group_by</a></span>(origin) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb75-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">summarize</a></span>(</a>
<a class="sourceLine" id="cb75-4" data-line-number="4">    <span class="dt">peak_count =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(da_padj)) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/n_distinct.html">n_distinct</a></span>(resample),</a>
<a class="sourceLine" id="cb75-5" data-line-number="5">    <span class="dt">lfc1_peak_count =</span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(da_log2FC) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/n_distinct.html">n_distinct</a></span>(resample),</a>
<a class="sourceLine" id="cb75-6" data-line-number="6">    <span class="dt">lfc2_peak_count =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(da_log2FC) <span class="op">&gt;</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/n_distinct.html">n_distinct</a></span>(resample)</a>
<a class="sourceLine" id="cb75-7" data-line-number="7">  )</a>
<a class="sourceLine" id="cb75-8" data-line-number="8">origin_peak_lfc</a></code></pre></div>
<pre><code>## DataFrame with 2 rows and 4 columns
##     origin peak_count lfc1_peak_count lfc2_peak_count
##   &lt;factor&gt;  &lt;numeric&gt;       &lt;numeric&gt;       &lt;numeric&gt;
## 1   not_de     2362.3           443.8            32.3
## 2   de         3416.0          1097.0           234.0</code></pre>
<p>Then for all variables except for the <code>origin</code> column we divide the first rows values by the second row, which will be the enrichment of peaks in DE genes compared to other genes. We see that the relative enrichment increases for a ‘larger’ LFC:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" data-line-number="1">origin_peak_lfc <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb77-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb77-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">select</a></span>(<span class="op">-</span>origin) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb77-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarize_all</a></span>(<span class="dt">.funs =</span> <span class="op">~</span><span class="kw"><a href="https://rdrr.io/r/base/funprog.html">Reduce</a></span>(<span class="cf">function</span>(x,y) y<span class="op">/</span>x, .))</a></code></pre></div>
<pre><code>##   peak_count lfc1_peak_count lfc2_peak_count
## 1   1.446048        2.471834        7.244582</code></pre>
<p>Un-tidy but avoid <code>.funs=~Reduce</code>?</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" data-line-number="1">m &lt;-<span class="st"> </span>origin_peak_lfc <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb79-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb79-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">select</a></span>(<span class="op">-</span>origin) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb79-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>()</a>
<a class="sourceLine" id="cb79-5" data-line-number="5">m[<span class="dv">2</span>,] <span class="op">/</span><span class="st"> </span>m[<span class="dv">1</span>,]</a></code></pre></div>
<pre><code>##      peak_count lfc1_peak_count lfc2_peak_count 
##        1.446048        2.471834        7.244582</code></pre>
<p>Due to the one-to-many mappings of DE genes to peaks, it is unknown if we have the same number of DE genes participating or less, as we increase the threshold on the peak LFC. This can be accounted for by grouping and aggregating twice. First, the number of peaks that meet the thresholds are computed within each gene, origin and resample group. Second, within the origin column, we compute the total number of peaks that meet the target threshold and the number of genes that have more than zero peaks (again averaging over the number of resamples).</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb81-1" data-line-number="1">genes_olap_peaks <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb81-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">group_by</a></span>(gene_id, origin, resample) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb81-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/ranges-reduce.html">reduce_ranges_directed</a></span>(</a>
<a class="sourceLine" id="cb81-4" data-line-number="4">    <span class="dt">lfc1 =</span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(da_log2FC) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">na.rm=</span><span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb81-5" data-line-number="5">    <span class="dt">lfc2=</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(da_log2FC) <span class="op">&gt;</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb81-6" data-line-number="6">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb81-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">group_by</a></span>(origin) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb81-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">summarize</a></span>(</a>
<a class="sourceLine" id="cb81-9" data-line-number="9">    <span class="dt">lfc1_gene_count =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(lfc1 <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/n_distinct.html">n_distinct</a></span>(resample),</a>
<a class="sourceLine" id="cb81-10" data-line-number="10">    <span class="dt">lfc1_peak_count =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(lfc1) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/n_distinct.html">n_distinct</a></span>(resample),</a>
<a class="sourceLine" id="cb81-11" data-line-number="11">    <span class="dt">lfc2_gene_count =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(lfc2 <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/n_distinct.html">n_distinct</a></span>(resample),</a>
<a class="sourceLine" id="cb81-12" data-line-number="12">    <span class="dt">lfc2_peak_count =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(lfc2) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/n_distinct.html">n_distinct</a></span>(resample)</a>
<a class="sourceLine" id="cb81-13" data-line-number="13">  )</a></code></pre></div>
<pre><code>## DataFrame with 2 rows and 5 columns
##     origin lfc1_gene_count lfc1_peak_count lfc2_gene_count lfc2_peak_count
##   &lt;factor&gt;       &lt;numeric&gt;       &lt;numeric&gt;       &lt;numeric&gt;       &lt;numeric&gt;
## 1   not_de           301.4           443.8            30.4            32.3
## 2   de               515.0          1097.0           151.0           234.0</code></pre>
<p>To do this for many thresholds is cumbersome and would create a lot of duplicate code, instead we create a single function called <code>count_above_threshold</code> that accepts a GRanges object, and computes the peak count that meets the threshold.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" data-line-number="1">count_if_above_threshold &lt;-<span class="st"> </span><span class="cf">function</span>(.data, threshold) {</a>
<a class="sourceLine" id="cb83-2" data-line-number="2">  <span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/ranges-reduce.html">reduce_ranges_directed</a></span>(.data,</a>
<a class="sourceLine" id="cb83-3" data-line-number="3">                         <span class="dt">threshold =</span> threshold,</a>
<a class="sourceLine" id="cb83-4" data-line-number="4">                         <span class="dt">value =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(da_log2FC) <span class="op">&gt;</span><span class="st"> </span>threshold, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb83-5" data-line-number="5">  )</a>
<a class="sourceLine" id="cb83-6" data-line-number="6">}</a></code></pre></div>
<p>The above function will compute the counts for any arbitrary threshold, now we need to apply it over possible LFC thresholds of interest. We choose a grid of one hundred thresholds based on the range of absolute LFC values in the <code>da_peaks</code> <em>GRanges</em> object:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" data-line-number="1">thresholds &lt;-<span class="st"> </span>da_peaks <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb84-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">mutate</a></span>(<span class="dt">abs_lfc =</span> <span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(da_log2FC)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb84-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/with.html">with</a></span>(</a>
<a class="sourceLine" id="cb84-4" data-line-number="4">    <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(abs_lfc), <span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(abs_lfc), <span class="dt">length.out =</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb84-5" data-line-number="5">  )</a></code></pre></div>
<p>The peaks are computed for each threshold value by applying the function <code>count_if_above_threshold()</code> on a <em>GRanges</em> object that has been grouped by the gene, origin and the number of resamples variables. This could be done easily in parallel with <code>BiocParallel</code> but here we compute everything serially .</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb85-1" data-line-number="1">by_gene_origin &lt;-<span class="st"> </span>genes_olap_peaks <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb85-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">group_by</a></span>(gene_id, origin, resample)</a>
<a class="sourceLine" id="cb85-3" data-line-number="3"></a>
<a class="sourceLine" id="cb85-4" data-line-number="4">genes_peak_all_thresholds &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/ranges-bind.html">bind_ranges</a></span>(</a>
<a class="sourceLine" id="cb85-5" data-line-number="5">  <span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(thresholds, count_if_above_threshold, <span class="dt">.data =</span> by_gene_origin)</a>
<a class="sourceLine" id="cb85-6" data-line-number="6">)</a></code></pre></div>
<p>This creates a very <em>long</em> GRanges object. To compute the peak and gene counts for each threshold, we apply the same summarization as before:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" data-line-number="1">origin_peak_all_thresholds &lt;-<span class="st"> </span>genes_peak_all_thresholds <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb86-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">group_by</a></span>(origin, threshold) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb86-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">summarize</a></span>(</a>
<a class="sourceLine" id="cb86-4" data-line-number="4">    <span class="dt">gene_count =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(value <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/n_distinct.html">n_distinct</a></span>(resample),</a>
<a class="sourceLine" id="cb86-5" data-line-number="5">    <span class="dt">peak_count =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(value) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/n_distinct.html">n_distinct</a></span>(resample)</a>
<a class="sourceLine" id="cb86-6" data-line-number="6">  )</a>
<a class="sourceLine" id="cb86-7" data-line-number="7">origin_peak_all_thresholds</a></code></pre></div>
<pre><code>## DataFrame with 200 rows and 4 columns
##       origin threshold gene_count peak_count
##     &lt;factor&gt; &lt;numeric&gt;  &lt;numeric&gt;  &lt;numeric&gt;
## 1     not_de 0.0658243      696.0     2362.2
## 2     not_de 0.1184840      688.7     2309.9
## 3     not_de 0.1711436      678.6     2197.8
## 4     not_de 0.2238033      666.4     2045.6
## 5     not_de 0.2764629      649.6     1878.0
## ...      ...       ...        ...        ...
## 196       de   5.06849          2          2
## 197       de   5.12115          0          0
## 198       de   5.17381          0          0
## 199       de   5.22647          0          0
## 200       de   5.27913          0          0</code></pre>
<p>Again we can compute the relative enrichment in LFCs in the same manner as before and visualize how enrichment changes as the threshold value increases:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" data-line-number="1">peak_enrichment &lt;-<span class="st"> </span>origin_peak_all_thresholds <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb88-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb88-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">group_by</a></span>(threshold) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb88-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/plyranges/man/tidyverse-reexports.html">summarize</a></span>(<span class="dt">enrichment =</span> <span class="kw"><a href="https://rdrr.io/r/base/funprog.html">Reduce</a></span>(<span class="cf">function</span>(x,y) y<span class="op">/</span>x, peak_count))</a>
<a class="sourceLine" id="cb88-5" data-line-number="5">peak_enrichment <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb88-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> threshold, <span class="dt">y =</span> enrichment)) <span class="op">+</span></a>
<a class="sourceLine" id="cb88-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb88-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="dt">x =</span> <span class="st">"logFC threshold"</span>, <span class="dt">y =</span> <span class="st">"Relative Enrichment"</span>)</a></code></pre></div>
<pre><code>## Warning: Removed 4 rows containing missing values (geom_path).</code></pre>
<p><img src="fluentGenomics_files/figure-html/unnamed-chunk-39-1.png" width="700"></p>
<p>We computed the sum of DA peaks near the DE genes, for increasing LFC thresholds on the accessibility change. As we increased the threshold, the number of total peaks went down (likewise the mean number of DA peaks per gene). It is also likely the number of DE genes with a DA peak nearby with such a large change went down - we can check this by plotting the number of DE genes against the number of DA peaks:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb90-1" data-line-number="1">origin_peak_all_thresholds <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> gene_count,</a>
<a class="sourceLine" id="cb90-4" data-line-number="4">             <span class="dt">y =</span> peak_count,</a>
<a class="sourceLine" id="cb90-5" data-line-number="5">             <span class="dt">color =</span> threshold)) <span class="op">+</span></a>
<a class="sourceLine" id="cb90-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb90-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_color_viridis_c</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb90-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span><span class="st"> </span>origin) <span class="op">+</span></a>
<a class="sourceLine" id="cb90-9" data-line-number="9"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="dt">x =</span> <span class="st">"Number of Genes"</span>,</a>
<a class="sourceLine" id="cb90-10" data-line-number="10">       <span class="dt">y =</span> <span class="st">"Number of Peaks"</span>,</a>
<a class="sourceLine" id="cb90-11" data-line-number="11">       <span class="dt">color =</span> <span class="st">"LFC threshold"</span>)</a></code></pre></div>
<p><img src="fluentGenomics_files/figure-html/unnamed-chunk-40-1.png" width="700"></p>
</div>
</div>
<div id="discussion" class="section level1">
<h1 class="hasAnchor">
<a href="#discussion" class="anchor"></a>Discussion</h1>
<p>We have shown that using <em>plyranges</em> and <em>tximeta</em> (with support of Bioconductor and <em>tidyverse</em> packages) that we can fluently iterate through the biological data science workflow: from import, through to modelling, wrangling and visualization.</p>
<p>Using <em>tximeta</em>, we have shown that it is straightforward to import RNA-seq quantification data, and that by ensuring the proper metadata is associated with it, we can guard against any mistakes in downstream analyses.</p>
<p>Using <em>plyranges</em>, we have extended the principles of the <em>tidyverse</em> to genomic ranges, and that by design we can leverage those packages to understand data measured along the genome. We have shown that analyses performed with <em>plyranges</em> clearly and (relatively) concisely express their intent; in most cases the code we have written closely matches it’s description in English and clarifies how the features of a genomic range is being modified.</p>
<p>There are several further steps that would be interesting to perform in this analysis; for example, we could modify window size around the TSS to see how it effects enrichment and vary the cut-offs applied to FDR percentages applied to both the DE and DA peaks.</p>
</div>
<div id="software-availability" class="section level1">
<h1 class="hasAnchor">
<a href="#software-availability" class="anchor"></a>Software Availability</h1>
<p>The workflow materials, including this article can be fully reproduced following the instructions found at the Github repository <a href="https://github.com/sa-lee/fluentGenomics">sa-lee/fluentGenomics</a>. Moreover, the workflow and all downstream dependencies can be installed</p>
<p>This article and the analyses were performed with R <span class="citation">(R Core Team 2019)</span> using the <em>rmarkdown</em> <span class="citation">(Allaire et al. 2019)</span>, <em>knitr</em> <span class="citation">(Xie 2019, 2015)</span> and <em>BiocWorkflowTools</em> <span class="citation">(Smith, Oleś, and Huber 2018)</span> packages.</p>
<div id="session-info" class="section level2">
<h2 class="hasAnchor">
<a href="#session-info" class="anchor"></a>Session Info</h2>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span>()</a></code></pre></div>
<pre><code>## R Under development (unstable) (2020-01-11 r77654)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 16.04.6 LTS
## 
## Matrix products: default
## BLAS:   /home/travis/R-bin/lib/R/lib/libRblas.so
## LAPACK: /home/travis/R-bin/lib/R/lib/libRlapack.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] parallel  stats4    stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] ggplot2_3.2.1               plyranges_1.7.6            
##  [3] DESeq2_1.27.19              GenomicFeatures_1.39.2     
##  [5] AnnotationDbi_1.49.0        SummarizedExperiment_1.17.1
##  [7] DelayedArray_0.13.2         BiocParallel_1.21.2        
##  [9] matrixStats_0.55.0          Biobase_2.47.2             
## [11] GenomicRanges_1.39.1        GenomeInfoDb_1.23.2        
## [13] IRanges_2.21.2              S4Vectors_0.25.9           
## [15] BiocGenerics_0.33.0         readr_1.3.1                
## [17] dplyr_0.8.3                 tximeta_1.5.15             
## [19] fluentGenomics_0.0.3       
## 
## loaded via a namespace (and not attached):
##  [1] colorspace_1.4-1              rprojroot_1.3-2              
##  [3] XVector_0.27.0                fs_1.3.1                     
##  [5] farver_2.0.1                  bit64_0.9-7                  
##  [7] interactiveDisplayBase_1.25.0 fansi_0.4.1                  
##  [9] splines_4.0.0                 tximport_1.15.5              
## [11] geneplotter_1.65.0            knitr_1.26                   
## [13] zeallot_0.1.0                 jsonlite_1.6                 
## [15] Rsamtools_2.3.2               annotate_1.65.0              
## [17] dbplyr_1.4.2                  shiny_1.4.0                  
## [19] BiocManager_1.30.10           compiler_4.0.0               
## [21] httr_1.4.1                    backports_1.1.5              
## [23] assertthat_0.2.1              Matrix_1.2-18                
## [25] fastmap_1.0.1                 lazyeval_0.2.2               
## [27] cli_2.0.1                     later_1.0.0                  
## [29] htmltools_0.4.0               prettyunits_1.1.0            
## [31] tools_4.0.0                   gtable_0.3.0                 
## [33] glue_1.3.1                    GenomeInfoDbData_1.2.2       
## [35] rappdirs_0.3.1                Rcpp_1.0.3                   
## [37] pkgdown_1.4.1                 vctrs_0.2.1                  
## [39] Biostrings_2.55.4             rtracklayer_1.47.0           
## [41] xfun_0.11                     stringr_1.4.0                
## [43] mime_0.8                      lifecycle_0.1.0              
## [45] ensembldb_2.11.2              XML_3.98-1.20                
## [47] AnnotationHub_2.19.3          zlibbioc_1.33.0              
## [49] MASS_7.3-51.5                 scales_1.1.0                 
## [51] hms_0.5.3                     promises_1.1.0               
## [53] ProtGenerics_1.19.3           AnnotationFilter_1.11.0      
## [55] RColorBrewer_1.1-2            yaml_2.2.0                   
## [57] curl_4.3                      memoise_1.1.0                
## [59] biomaRt_2.43.1                stringi_1.4.5                
## [61] RSQLite_2.2.0                 BiocVersion_3.11.1           
## [63] genefilter_1.69.0             desc_1.2.0                   
## [65] rlang_0.4.2                   pkgconfig_2.0.3              
## [67] bitops_1.0-6                  evaluate_0.14                
## [69] lattice_0.20-38               purrr_0.3.3                  
## [71] GenomicAlignments_1.23.1      labeling_0.3                 
## [73] bit_1.1-14                    tidyselect_0.2.5             
## [75] magrittr_1.5                  bookdown_0.17                
## [77] R6_2.4.1                      DBI_1.1.0                    
## [79] pillar_1.4.3                  withr_2.1.2                  
## [81] survival_3.1-8                RCurl_1.95-4.12              
## [83] tibble_2.1.3                  crayon_1.3.4                 
## [85] utf8_1.1.4                    BiocFileCache_1.11.4         
## [87] rmarkdown_2.0                 progress_1.2.2               
## [89] locfit_1.5-9.1                grid_4.0.0                   
## [91] blob_1.2.0                    digest_0.6.23                
## [93] xtable_1.8-4                  httpuv_1.5.2                 
## [95] openssl_1.4.1                 munsell_0.5.0                
## [97] viridisLite_0.3.0             askpass_1.1</code></pre>
</div>
<div id="author-contributions" class="section level2">
<h2 class="hasAnchor">
<a href="#author-contributions" class="anchor"></a>Author Contributions</h2>
<p>All authors contributed to the writing and development of the workflow.</p>
</div>
<div id="competing-interests" class="section level2">
<h2 class="hasAnchor">
<a href="#competing-interests" class="anchor"></a>Competing interests</h2>
<p>The authors declare that they have no competing interests.</p>
</div>
<div id="funding" class="section level2">
<h2 class="hasAnchor">
<a href="#funding" class="anchor"></a>Funding</h2>
<p>SL is supported by an Australian Government Research Training Program (RTP) scholarship with a top up scholarship from CSL Limited.</p>
<p>MIL’s contribution is supported by NIH grant R01 HG009937.</p>
<p><strong>I confirm that the funders had no role in study design, data collection and analysis, decision to publish, or preparation of the manuscript.</strong></p>
</div>
<div id="acknowledgements" class="section level2">
<h2 class="hasAnchor">
<a href="#acknowledgements" class="anchor"></a>Acknowledgements</h2>
<p>The authors would like to thank all participants of the Bioconductor 2019 and BiocAsia 2019 conferences who attended and provided feedback on early versions of this workflow paper.</p>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-alasooZenodo">
<p>Alasoo, Kaur, and Daniel Gaffney. 2017. “Processed read counts from macrophage RNA-seq and ATAC-seq experiments.” Zenodo. <a href="https://doi.org/10.5281/zenodo.1188300" class="uri">https://doi.org/10.5281/zenodo.1188300</a>.</p>
</div>
<div id="ref-alasoo">
<p>Alasoo, K, J Rodrigues, S Mukhopadhyay, AJ Knights, AL Mann, K Kundu, HIPSCI-Consortium, C Hale, Dougan G, and DJ Gaffney. 2018. “Shared genetic effects on chromatin and gene expression indicate a role for enhancer priming in immune response.” <em>Nature Genetics</em> 50: 424–31. <a href="https://doi.org/10.1038/s41588-018-0046-7" class="uri">https://doi.org/10.1038/s41588-018-0046-7</a>.</p>
</div>
<div id="ref-rmarkdown">
<p>Allaire, JJ, Yihui Xie, Jonathan McPherson, Javier Luraschi, Kevin Ushey, Aron Atkins, Hadley Wickham, Joe Cheng, Winston Chang, and Richard Iannone. 2019. <em>Rmarkdown: Dynamic Documents for R</em>. <a href="https://github.com/rstudio/rmarkdown" class="uri">https://github.com/rstudio/rmarkdown</a>.</p>
</div>
<div id="ref-gencode">
<p>Frankish, A, GENCODE-consoritum, and P Flicek. 2018. “GENCODE reference annotation for the human and mouse genomes.” <em>Nucleic Acids Research</em>. <a href="https://doi.org/10.1093/nar/gky955" class="uri">https://doi.org/10.1093/nar/gky955</a>.</p>
</div>
<div id="ref-Hansen2012">
<p>Hansen, Kasper D., Rafael A. Irizarry, and Zhijin Wu. 2012. “Removing technical variability in RNA-seq data using condition quantile normalization.” <em>Biostatistics</em> 13 (2): 204–16. <a href="https://doi.org/10.1093/biostatistics/kxr054" class="uri">https://doi.org/10.1093/biostatistics/kxr054</a>.</p>
</div>
<div id="ref-snakemake">
<p>Köster, Johannes, and Sven Rahmann. 2012. “Snakemake—a scalable bioinformatics workflow engine.” <em>Bioinformatics</em> 28 (19): 2520–2. <a href="https://doi.org/10.1093/bioinformatics/bts480" class="uri">https://doi.org/10.1093/bioinformatics/bts480</a>.</p>
</div>
<div id="ref-Law2018-f1000">
<p>Law, Charity W, Monther Alhamdoosh, Shian Su, Xueyi Dong, Luyi Tian, Gordon K Smyth, and Matthew E Ritchie. 2018. “RNA-seq Analysis Is Easy as 1-2-3 with Limma, Glimma and edgeR.” <em>F1000Res.</em> 5 (1408). F1000 Research Limited: 1408. <a href="https://doi.org/10.12688/f1000research.9005.3" class="uri">https://doi.org/10.12688/f1000research.9005.3</a>.</p>
</div>
<div id="ref-granges">
<p>Lawrence, Wolfgang AND Pagès, Michael AND Huber. 2013. “Software for Computing and Annotating Genomic Ranges.” <em>PLOS Computational Biology</em> 9 (8). Public Library of Science: 1–10. <a href="https://doi.org/10.1371/journal.pcbi.1003118" class="uri">https://doi.org/10.1371/journal.pcbi.1003118</a>.</p>
</div>
<div id="ref-Lee2019">
<p>Lee, Stuart, Dianne Cook, and Michael Lawrence. 2019. “Plyranges: A Grammar of Genomic Data Transformation.” <em>Genome Biology</em> 20 (1): 4. <a href="https://doi.org/10.1186/s13059-018-1597-8" class="uri">https://doi.org/10.1186/s13059-018-1597-8</a>.</p>
</div>
<div id="ref-Love2016-f1000">
<p>Love, Michael I, Simon Anders, Vladislav Kim, and Wolfgang Huber. 2016. “RNA-Seq Workflow: Gene-Level Exploratory Analysis and Differential Expression.” <em>F1000Res.</em> 4 (1070). F1000 Research Limited: 1070. <a href="https://doi.org/10.12688/f1000research.7035.2" class="uri">https://doi.org/10.12688/f1000research.7035.2</a>.</p>
</div>
<div id="ref-Love2014">
<p>Love, Michael I., Wolfgang Huber, and Simon Anders. 2014. “Moderated estimation of fold change and dispersion for RNA-seq data with DESeq2.” <em>Genome Biology</em> 15 (12): 550. <a href="https://doi.org/10.1186/s13059-014-0550-8" class="uri">https://doi.org/10.1186/s13059-014-0550-8</a>.</p>
</div>
<div id="ref-Love2019-tximeta">
<p>Love, Michael I, Charlotte Soneson, Peter F Hickey, Lisa K Johnson, N Tessa Pierce, Lori Shepherd, Martin Morgan, and Rob Patro. 2019. “Tximeta: Reference Sequence Checksums for Provenance Identification in RNA-seq.” <em>bioRxiv</em>, September, 777888. <a href="https://doi.org/10.1101/777888" class="uri">https://doi.org/10.1101/777888</a>.</p>
</div>
<div id="ref-salmon">
<p>Patro, R, G Duggal, MI Love, RA Irizarry, and C Kingsford. 2017. “Salmon Provides Fast and Bias-Aware Quantification of Transcript Expression.” <em>Nature Methods</em> 14: 417–19. <a href="https://doi.org/10.1038/nmeth.4197" class="uri">https://doi.org/10.1038/nmeth.4197</a>.</p>
</div>
<div id="ref-baser">
<p>R Core Team. 2019. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/" class="uri">https://www.R-project.org/</a>.</p>
</div>
<div id="ref-bcfilecache">
<p>Shepherd, Lori, and Martin Morgan. 2019. <em>BiocFileCache: Manage Files Across Sessions</em>.</p>
</div>
<div id="ref-bcworkflowtools">
<p>Smith, Mike L., Andrzej K. Oleś, and Wolfgang Huber. 2018. “Authoring Bioconductor Workflows with Biocworkflowtools [Version 1; Referees: 2 Approved with Reservations].” <em>F1000Research</em>, no. 7: 431. <a href="https://doi.org/10.12688/f1000research.14399.1" class="uri">https://doi.org/10.12688/f1000research.14399.1</a>.</p>
</div>
<div id="ref-Smyth2004">
<p>Smyth, Gordon K. 2004. “Linear Models and Empirical Bayes Methods for Assessing Differential Expression in Microarray Experiments.” <em>Statistical Applications in Genetics and Molecular Biology</em> 3 (1).</p>
</div>
<div id="ref-Soneson2015">
<p>Soneson, Charlotte, Michael I. Love, and Mark Robinson. 2015. “Differential analyses for RNA-seq: transcript-level estimates improve gene-level inferences.” <em>F1000Research</em> 4 (1521). <a href="https://doi.org/10.12688/f1000research.7563.1" class="uri">https://doi.org/10.12688/f1000research.7563.1</a>.</p>
</div>
<div id="ref-tidyverse">
<p>Wickham, Hadley, Mara Averick, Jennifer Bryan, Winston Chang, Lucy D’Agostino McGowan, Romain François, Garrett Grolemund, et al. 2019. “Welcome to the tidyverse.” <em>Journal of Open Source Software</em> 4 (43): 1686. <a href="https://doi.org/10.21105/joss.01686" class="uri">https://doi.org/10.21105/joss.01686</a>.</p>
</div>
<div id="ref-xie2015">
<p>Xie, Yihui. 2015. <em>Dynamic Documents with R and Knitr</em>. 2nd ed. Boca Raton, Florida: Chapman; Hall/CRC. <a href="https://yihui.name/knitr/" class="uri">https://yihui.name/knitr/</a>.</p>
</div>
<div id="ref-knitr">
<p>———. 2019. <em>Knitr: A General-Purpose Package for Dynamic Report Generation in R</em>. <a href="https://yihui.name/knitr/" class="uri">https://yihui.name/knitr/</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#introduction">Introduction</a><ul class="nav nav-pills nav-stacked">
<li><a href="#experimental-data">Experimental Data</a></li>
      </ul>
</li>
      <li>
<a href="#se">Import Data as a <em>SummarizedExperiment</em></a><ul class="nav nav-pills nav-stacked">
<li><a href="#using-tximeta-to-import-rna-seq-quantification-data">Using <em>tximeta</em> to import RNA-seq quantification data</a></li>
      <li><a href="#importing-atac-seq-data-as-a-summarizedexperiment-object">Importing ATAC-seq data as a <em>SummarizedExperiment</em> object</a></li>
      </ul>
</li>
      <li>
<a href="#model">Model</a><ul class="nav nav-pills nav-stacked">
<li><a href="#rna-seq-differential-gene-expression-analysis">RNA-seq differential gene expression analysis</a></li>
      <li><a href="#atac-seq-peak-differential-abundance-analysis">ATAC-seq peak differential abundance analysis</a></li>
      </ul>
</li>
      <li>
<a href="#transform">Transform</a><ul class="nav nav-pills nav-stacked">
<li><a href="#finding-overlaps-with-plyranges">Finding overlaps with <em>plyranges</em></a></li>
      <li><a href="#down-sampling-non-differentially-expressed-genes">Down sampling non-differentially expressed genes</a></li>
      <li><a href="#expanding-genomic-coordinates-around-the-transcription-start-site">Expanding genomic coordinates around the transcription start site</a></li>
      <li><a href="#use-overlap-joins-to-find-relative-enrichment">Use overlap joins to find relative enrichment</a></li>
      </ul>
</li>
      <li><a href="#discussion">Discussion</a></li>
      <li>
<a href="#software-availability">Software Availability</a><ul class="nav nav-pills nav-stacked">
<li><a href="#session-info">Session Info</a></li>
      <li><a href="#author-contributions">Author Contributions</a></li>
      <li><a href="#competing-interests">Competing interests</a></li>
      <li><a href="#funding">Funding</a></li>
      <li><a href="#acknowledgements">Acknowledgements</a></li>
      </ul>
</li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Stuart Lee, Michael Love.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
